// Esquema de base de datos para Matched Betting

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Personas con las que haces operaciones
model Person {
  id             String   @id @default(cuid())
  userId         String?  // ID del usuario de Supabase Auth (temporal opcional para migración)
  name           String
  phone          String?  // Teléfono para identificar en Bizum
  notes          String?
  commissionType String   @default("fixed_total") // "fixed_total" (pago único) o "per_operation" (por cada casa)
  commission     Float    @default(0) // Cantidad de comisión (total o por operación según commissionType)
  commissionPaid Float    @default(0) // Comisión ya pagada a esta persona
  paused         Boolean  @default(false) // Si está pausada, no se muestran casas disponibles
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  operations   Operation[]
  transactions Transaction[]

  @@index([userId])
}

// Casas de apuestas con configuración de bonos
model Bookmaker {
  id              String   @id @default(cuid())
  name            String   @unique

  // Tipo de bono
  bonusType       String   // "always" (siempre dan bono) o "only_if_lost" (solo si pierdes)

  // Configuración del depósito
  minDeposit      Float    // Depósito mínimo
  maxDeposit      Float    // Depósito máximo para el bono
  numDeposits     Int      @default(1) // Número de depósitos (Sportium: 2)

  // Configuración qualifying
  numQualifying   Int      @default(1) // Número de apuestas qualifying
  minOddsQualifying Float  @default(1.5) // Cuota mínima qualifying

  // Configuración freebet
  bonusPercentage Float    @default(100) // Porcentaje del bono (Winamax: 150%)
  maxBonus        Float    // Máximo del bono en euros
  numFreebets     Int      @default(1) // Número de freebets (Retabet: 6)
  freebetValue    Float?   // Valor de cada freebet si son fijas (Retabet: 25€)
  freebetRetention Float   @default(0.80) // Retención esperada del freebet (0.75-0.80 típico)
  minOddsFreebet  Float?   // Cuota mínima freebet
  maxOddsFreebet  Float?   // Cuota máxima freebet (Retabet: 3.50)
  sameEvent       Boolean  @default(true) // Pueden ser al mismo evento

  // Plazos
  daysToDeposit   Int?     // Días para depositar
  daysToQualify   Int?     // Días para hacer qualifying
  daysFreebetValid Int?    // Días de validez de freebet

  // Otros
  promoCode       String?  // Código promocional
  notes           String?  // Notas importantes (ej: "mismo dispositivo")
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  operations      Operation[]
}

// Cada operación de bono
model Operation {
  id              String    @id @default(cuid())
  userId          String?   // ID del usuario de Supabase Auth (temporal opcional para migración)
  personId        String
  person          Person    @relation(fields: [personId], references: [id], onDelete: Cascade)

  bookmakerId     String
  bookmaker       Bookmaker @relation(fields: [bookmakerId], references: [id])

  status          String    @default("pending") // pending, qualifying, freebet, completed, cancelled

  // Dinero
  bizumSent       Float     @default(0) // Dinero que TÚ enviaste por Bizum
  moneyReturned   Float     @default(0) // Dinero que te devolvió la persona
  commissionPaid  Float     @default(0) // Comisión pagada a la persona

  // Depósitos (puede haber varios, ej: Sportium)
  deposits        Deposit[]

  // Apuestas
  bets            Bet[]

  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Una persona solo puede tener una operación por casa de apuestas
  @@unique([personId, bookmakerId])
  @@index([userId])
}

// Depósitos (para casas que requieren múltiples depósitos como Sportium)
model Deposit {
  id          String    @id @default(cuid())
  operationId String
  operation   Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  amount      Float     // Cantidad depositada
  depositNum  Int       // Número de depósito (1, 2, etc.)
  completed   Boolean   @default(false)

  createdAt   DateTime  @default(now())
}

// Cada apuesta individual (qualifying o freebet)
model Bet {
  id              String    @id @default(cuid())
  operationId     String
  operation       Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  betType         String    // "qualifying" o "freebet"
  betNumber       Int       @default(1) // Número de apuesta (1, 2, 3... para múltiples)

  stake           Float     // Cantidad apostada
  oddsBack        Float     // Cuota en la casa
  oddsLay         Float     // Cuota en el exchange

  // Calculados automáticamente
  liability       Float     @default(0) // Lo que arriesgas en exchange
  expectedProfit  Float     @default(0) // Beneficio esperado

  result          String?   // "won" (ganó en casa), "lost" (perdió en casa), null (pendiente)
  actualProfit    Float?    // Beneficio real después del resultado

  eventName       String?   // Nombre del evento
  eventDate       DateTime? // Fecha del evento

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Transacciones (Bizums, transferencias) - para importar de Revolut
model Transaction {
  id          String   @id @default(cuid())
  personId    String?
  person      Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)

  type        String   // "bizum_sent", "bizum_received", "transfer"
  amount      Float
  description String?
  date        DateTime @default(now())

  revolutId   String?  @unique // ID único de Revolut para evitar duplicados

  createdAt   DateTime @default(now())
}

// Configuración por usuario (saldo del exchange, etc.)
model Settings {
  id              String   @id @default(cuid())
  userId          String?  // ID del usuario de Supabase Auth (temporal opcional para migración)
  exchangeBalance Float    @default(0) // Saldo actual en el exchange (Betfair)
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// Usuarios registrados (para control de acceso)
model User {
  id         String   @id @default(cuid())
  supabaseId String   @unique // ID de Supabase Auth
  email      String   @unique
  isAdmin    Boolean  @default(false)
  isApproved Boolean  @default(false) // Solo pueden entrar si están aprobados
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
